services:
  planka:
    image: ghcr.io/plankanban/planka:2.0.0-rc.4
    restart: on-failure
    volumes:
      - favicons:/app/public/favicons
      - user-avatars:/app/public/user-avatars
      - background-images:/app/public/background-images
      - attachments:/app/private/attachments
    # Optionally override this to your user/group
    # user: 1000:1000
    # tmpfs:
    #   - /app/.tmp:mode=770,uid=1000,gid=1000
    ports:
      - 1337  # Expose internal port only - Dokploy handles external routing
    environment:
      # Set BASE_URL in Dokploy UI to your actual domain (e.g., https://planka.yourdomain.com)
      - BASE_URL=${BASE_URL:-http://localhost:3000}
      # Database connection - uses env vars from Dokploy
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB:-planka}

      # Optionally store the database password in secrets:
      # - DATABASE_URL=postgresql://postgres:$${DATABASE_PASSWORD}@postgres/planka
      # - DATABASE_PASSWORD__FILE=/run/secrets/database_password
      # And add the following to the service:
      # secrets:
      #   - database_password

      # Secret key - MUST be set in Dokploy environment variables
      - SECRET_KEY=${SECRET_KEY:-notsecretkey}

      # Optional settings
      - TRUST_PROXY=${TRUST_PROXY:-true}
      - LOG_LEVEL=${LOG_LEVEL:-warn}
      - MAX_UPLOAD_FILE_SIZE=${MAX_UPLOAD_FILE_SIZE}
      - TOKEN_EXPIRES_IN=${TOKEN_EXPIRES_IN:-365}
      - DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE:-en-US}

      # Default admin user (set in Dokploy environment variables)
      - DEFAULT_ADMIN_EMAIL=${DEFAULT_ADMIN_EMAIL}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD}
      - DEFAULT_ADMIN_NAME=${DEFAULT_ADMIN_NAME}
      - DEFAULT_ADMIN_USERNAME=${DEFAULT_ADMIN_USERNAME}

      # - INTERNAL_ACCESS_TOKEN=
      # - STORAGE_LIMIT=
      # - ACTIVE_USERS_LIMIT=

      # Set to true to show more detailed authentication error messages.
      # It should not be enabled without a rate limiter for security reasons.
      # - SHOW_DETAILED_AUTH_ERRORS=false

      # S3 storage (optional)
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_BUCKET=${S3_BUCKET}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}

      # OIDC authentication (set in Dokploy environment variables)
      - OIDC_ISSUER=${OIDC_ISSUER}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - OIDC_USE_OAUTH_CALLBACK=${OIDC_USE_OAUTH_CALLBACK}
      - OIDC_ID_TOKEN_SIGNED_RESPONSE_ALG=${OIDC_ID_TOKEN_SIGNED_RESPONSE_ALG}
      - OIDC_USERINFO_SIGNED_RESPONSE_ALG=${OIDC_USERINFO_SIGNED_RESPONSE_ALG}
      - OIDC_SCOPES=${OIDC_SCOPES:-openid email profile}
      - OIDC_RESPONSE_MODE=${OIDC_RESPONSE_MODE}
      - OIDC_USE_DEFAULT_RESPONSE_MODE=${OIDC_USE_DEFAULT_RESPONSE_MODE}
      - OIDC_ADMIN_ROLES=${OIDC_ADMIN_ROLES}
      - OIDC_PROJECT_OWNER_ROLES=${OIDC_PROJECT_OWNER_ROLES}
      - OIDC_BOARD_USER_ROLES=${OIDC_BOARD_USER_ROLES}
      - OIDC_CLAIMS_SOURCE=${OIDC_CLAIMS_SOURCE}
      - OIDC_EMAIL_ATTRIBUTE=${OIDC_EMAIL_ATTRIBUTE}
      - OIDC_NAME_ATTRIBUTE=${OIDC_NAME_ATTRIBUTE}
      - OIDC_USERNAME_ATTRIBUTE=${OIDC_USERNAME_ATTRIBUTE}
      - OIDC_ROLES_ATTRIBUTE=${OIDC_ROLES_ATTRIBUTE}
      - OIDC_IGNORE_USERNAME=${OIDC_IGNORE_USERNAME}
      - OIDC_IGNORE_ROLES=${OIDC_IGNORE_ROLES}
      - OIDC_ENFORCED=${OIDC_ENFORCED}

      # Email/SMTP settings (set in Dokploy environment variables)
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_NAME=${SMTP_NAME}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_TLS_REJECT_UNAUTHORIZED=${SMTP_TLS_REJECT_UNAUTHORIZED}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM=${SMTP_FROM}

      # Using Gravatar directly exposes user IPs and hashed emails to a third party (GDPR risk).
      # Use a proxy you control for privacy, or leave commented out or empty to disable.
      # - GRAVATAR_BASE_URL=https://www.gravatar.com/avatar/
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:16-alpine
    restart: on-failure
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      # These will be overridden by Dokploy environment variables
      - POSTGRES_DB=${POSTGRES_DB:-planka}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-planka}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  favicons:
  user-avatars:
  background-images:
  attachments:
  db-data:
